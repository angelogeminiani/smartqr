/**
 * Module Dependencies
 */
var utilsFs = require('./lib/utilsFs.js')
    , smartforge = require('./index.js')
    , echoservice = require('./lib/module_socket/services/echo.js')
    , application = require('./lib/application')
    , middleware = application.middleware
    ;


var smartserver = new smartforge.SmartServer(
        {
            dirname: __dirname,
            debug:true
        });

smartserver.taskmanager.on('run', function (tm, task) {
    console.log('RUN: ' + task.name);
});

smartserver.taskmanager.on('custom_event', function (task) {
    console.log('EVENT: "custom_event" from' + task.name);
});

var task = smartserver.taskmanager.createTask();
task.func = function (tm) {
    console.log(task._count);
    tm.emit('custom_event', task);
};
task.repeat = 2;
smartserver.taskmanager.add(task);

//-- socket services --//
var socket = smartserver.socket,
    echo = new echoservice.EchoService();
socket.addService(echo, socket.DEF_CHANNEL);    // register echo service on '[/]socket'

//-- add redirect middleware --//
smartserver.addMiddleware(middleware.redirect301({redirmap:smartserver.settings.redirections.redirect301}));

//-- START --//
smartserver.open();

application.info(smartserver); // inspect the server
application.info("STARTED: " + smartserver.toString());